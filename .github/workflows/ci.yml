name: CI Pipeline

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    workflow_dispatch:

jobs:
    lint-and-format:
        name: Lint & Format Check
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Check formatting
              run: npm run format:check

            - name: Run ESLint
              run: npm run lint

    test-cloud-api:
        name: Test Cloud API
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install yt-dlp
              run: |
                  sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
                  sudo chmod a+rx /usr/local/bin/yt-dlp
                  yt-dlp --version

            - name: Install Cloud API dependencies
              working-directory: ./cloud_api
              run: npm ci

            - name: Run Cloud API tests (all)
              working-directory: ./cloud_api
              run: npm run test:all
              env:
                  NODE_ENV: test
                  PORT: 3000
                  REQUIRE_AUTH: false

            - name: Upload coverage reports
              if: always()
              uses: codecov/codecov-action@v4
              with:
                  files: ./cloud_api/coverage/lcov.info
                  flags: cloud-api
                  name: cloud-api-coverage

    test-native-host:
        name: Test Native Host
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install yt-dlp
              run: |
                  sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
                  sudo chmod a+rx /usr/local/bin/yt-dlp
                  yt-dlp --version

            - name: Install Python dependencies
              working-directory: ./native_host
              run: |
                  pip install pytest pytest-cov
                  if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

            - name: Run Python tests
              working-directory: ./native_host
              run: |
                  if [ -f test_ytdlp_host.py ]; then
                    pytest --cov=ytdlp_host --cov-report=xml --cov-report=term
                  else
                    echo "No tests found - skipping"
                  fi

    security-scan:
        name: Security Scan
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Run npm audit
              run: npm audit --audit-level=moderate || true

            - name: Run npm audit (Cloud API)
              working-directory: ./cloud_api
              run: npm audit --audit-level=moderate || true

            - name: Run Snyk security scan
              uses: snyk/actions/node@master
              continue-on-error: true
              env:
                  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
              with:
                  args: --severity-threshold=high

    build-docker:
        name: Build Docker Image
        runs-on: ubuntu-latest
        needs: [lint-and-format, test-cloud-api]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image
              uses: docker/build-push-action@v5
              with:
                  context: ./cloud_api
                  file: ./cloud_api/Dockerfile
                  push: false
                  tags: ytdlp-sizer-api:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Test Docker image
              run: |
                  docker build -t ytdlp-sizer-api:test ./cloud_api
                  docker run --rm ytdlp-sizer-api:test node -e "console.log('Docker image works')"

    validate-extension:
        name: Validate Extension Manifest
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Validate manifest.json
              run: |
                  if ! jq empty manifest.json 2>/dev/null; then
                    echo "❌ Invalid JSON in manifest.json"
                    exit 1
                  fi
                  echo "✅ manifest.json is valid JSON"

            - name: Check required manifest fields
              run: |
                  REQUIRED_FIELDS=("manifest_version" "name" "version" "description")
                  for field in "${REQUIRED_FIELDS[@]}"; do
                    if ! jq -e ".$field" manifest.json >/dev/null; then
                      echo "❌ Missing required field: $field"
                      exit 1
                    fi
                  done
                  echo "✅ All required manifest fields present"

    all-checks-passed:
        name: All Checks Passed
        runs-on: ubuntu-latest
        needs:
            [
                lint-and-format,
                test-cloud-api,
                test-native-host,
                security-scan,
                build-docker,
                validate-extension,
            ]
        if: always()

        steps:
            - name: Check all jobs
              run: |
                  if [ "${{ needs.lint-and-format.result }}" != "success" ] || \
                     [ "${{ needs.test-cloud-api.result }}" != "success" ] || \
                     [ "${{ needs.test-native-host.result }}" != "success" ] || \
                     [ "${{ needs.security-scan.result }}" != "success" ] || \
                     [ "${{ needs.build-docker.result }}" != "success" ] || \
                     [ "${{ needs.validate-extension.result }}" != "success" ]; then
                    echo "❌ Some checks failed"
                    exit 1
                  fi
                  echo "✅ All checks passed!"
