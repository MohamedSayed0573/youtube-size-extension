name: Build, Push, and Deploy

on:
    workflow_run:
        workflows: ["CI Pipeline"]
        branches: [main]
        types:
            - completed
    workflow_dispatch:

jobs:
    build-and-push:
        name: Build & Push to Docker Hub
        if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Build and push API
              uses: docker/build-push-action@v5
              with:
                  context: ./cloud_api
                  push: true
                  tags: |
                      ${{ secrets.DOCKER_USERNAME }}/ytdlp-api:latest
                      ${{ secrets.DOCKER_USERNAME }}/ytdlp-api:${{ github.sha }}
                  build-args: |
                      YTDLP_VERSION=${{ github.run_id }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Build and push HAProxy
              uses: docker/build-push-action@v5
              with:
                  context: ./cloud_api
                  file: ./cloud_api/Dockerfile.haproxy
                  push: true
                  tags: |
                      ${{ secrets.DOCKER_USERNAME }}/ytdlp-haproxy:latest
                      ${{ secrets.DOCKER_USERNAME }}/ytdlp-haproxy:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    deploy:
        name: Deploy to AWS EC2
        needs: build-and-push
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy via SSH
              uses: appleboy/ssh-action@v1.0.3
              env:
                  API_KEY: ${{ secrets.API_KEY }}
                  ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS }}
                  REDIS_URL: ${{ secrets.REDIS_URL }}
                  SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
                  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
                  PORT: ${{ vars.PORT }}
                  NODE_ENV: ${{ vars.NODE_ENV }}
                  REQUIRE_AUTH: ${{ vars.REQUIRE_AUTH }}
                  RATE_LIMIT_WINDOW_MS: ${{ vars.RATE_LIMIT_WINDOW_MS }}
                  RATE_LIMIT_MAX_REQUESTS: ${{ vars.RATE_LIMIT_MAX_REQUESTS }}
                  YTDLP_TIMEOUT: ${{ vars.YTDLP_TIMEOUT }}
                  YTDLP_MAX_BUFFER: ${{ vars.YTDLP_MAX_BUFFER }}
                  ENABLE_HEALTH_DETAILS: ${{ vars.ENABLE_HEALTH_DETAILS }}
              with:
                  host: ${{ secrets.EC2_IP }}
                  username: ubuntu
                  key: ${{ secrets.EC2_SSH_KEY }}
                  envs: API_KEY,ALLOWED_ORIGINS,REDIS_URL,SENTRY_DSN,DOCKER_USERNAME,PORT,NODE_ENV,REQUIRE_AUTH,RATE_LIMIT_WINDOW_MS,RATE_LIMIT_MAX_REQUESTS,YTDLP_TIMEOUT,YTDLP_MAX_BUFFER,ENABLE_HEALTH_DETAILS
                  script: |
                      # Navigate to app directory
                      cd /opt/ytdlp-api

                      # Create .env file from environment variables
                      cat > .env << EOF
                      PORT=${PORT}
                      NODE_ENV=${NODE_ENV}
                      REQUIRE_AUTH=${REQUIRE_AUTH}
                      API_KEY=${API_KEY}
                      ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
                      RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS}
                      RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS}
                      REDIS_URL=${REDIS_URL}
                      SENTRY_DSN=${SENTRY_DSN}
                      YTDLP_TIMEOUT=${YTDLP_TIMEOUT}
                      YTDLP_MAX_BUFFER=${YTDLP_MAX_BUFFER}
                      ENABLE_HEALTH_DETAILS=${ENABLE_HEALTH_DETAILS}
                      EOF

                      # Ensure proper permissions
                      chmod 600 .env

                      # Create network if not exists
                      sudo docker network create ytdlp-network 2>/dev/null || true

                      # Pull latest images
                      sudo docker pull ${DOCKER_USERNAME}/ytdlp-api:latest
                      sudo docker pull ${DOCKER_USERNAME}/ytdlp-haproxy:latest

                      # Stop and remove existing containers
                      sudo docker stop ytdlp-haproxy ytdlp-api 2>/dev/null || true
                      sudo docker rm ytdlp-haproxy ytdlp-api 2>/dev/null || true

                      # Run API container (internal)
                      sudo docker run -d \
                        --name ytdlp-api \
                        --restart unless-stopped \
                        --network ytdlp-network \
                        --network-alias api \
                        --env-file .env \
                        -v /opt/ytdlp-api/logs:/app/logs \
                        ${DOCKER_USERNAME}/ytdlp-api:latest

                      # Run HAProxy container (exposed)
                      sudo docker run -d \
                        --name ytdlp-haproxy \
                        --restart unless-stopped \
                        --network ytdlp-network \
                        -p 80:80 \
                        -p 8404:8404 \
                        ${DOCKER_USERNAME}/ytdlp-haproxy:latest

                      # Verify health with retries (allow 40s for startup)
                      echo "Waiting for application to start..."
                      for i in {1..8}; do
                        sleep 5
                        if curl -sf http://localhost:80/health > /dev/null 2>&1; then
                          echo "✅ Application is healthy!"
                          exit 0
                        fi
                        echo "Attempt $i/8: Application not ready yet..."
                      done
                      echo "❌ Health check failed after 40 seconds"
                      sudo docker logs ytdlp-api --tail 50
                      sudo docker logs ytdlp-haproxy --tail 50
                      exit 1
