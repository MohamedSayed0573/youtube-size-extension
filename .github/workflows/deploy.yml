name: Build, Push, and Deploy

on:
    workflow_run:
        workflows: ["CI Pipeline"]
        branches: [main]
        types:
            - completed
    workflow_dispatch:

jobs:
    build-and-push:
        name: Build & Push to Docker Hub
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Build and push
              uses: docker/build-push-action@v5
              with:
                  context: ./cloud_api
                  push: true
                  tags: |
                      ${{ secrets.DOCKER_USERNAME }}/ytdlp-api:latest
                      ${{ secrets.DOCKER_USERNAME }}/ytdlp-api:${{ github.sha }}
                  build-args: |
                      YTDLP_VERSION=${{ github.run_id }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    deploy:
        name: Deploy to AWS EC2
        needs: build-and-push
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy via SSH
              uses: appleboy/ssh-action@v1.0.3
              env:
                  API_KEY: ${{ secrets.API_KEY || 'dev-api-key-please-change' }}
                  ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS || '*' }}
                  REDIS_ENABLED: ${{ secrets.REDIS_ENABLED || 'false' }}
                  REDIS_URL: ${{ secrets.REDIS_URL || '' }}
                  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
              with:
                  host: ${{ secrets.EC2_IP }}
                  username: ubuntu
                  key: ${{ secrets.EC2_SSH_KEY }}
                  envs: API_KEY,ALLOWED_ORIGINS,REDIS_ENABLED,REDIS_URL,DOCKER_USERNAME
                  script: |
                      # Navigate to app directory
                      cd /opt/ytdlp-api

                      # Create .env file from environment variables
                      cat > .env << EOF
                      PORT=80
                      NODE_ENV=production
                      REQUIRE_AUTH=true
                      API_KEY=${API_KEY}
                      ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
                      RATE_LIMIT_WINDOW_MS=60000
                      RATE_LIMIT_MAX_REQUESTS=20
                      REDIS_ENABLED=${REDIS_ENABLED}
                      REDIS_URL=${REDIS_URL}
                      YTDLP_TIMEOUT=25000
                      YTDLP_MAX_BUFFER=10485760
                      ENABLE_HEALTH_DETAILS=false
                      EOF

                      # Ensure proper permissions
                      chmod 600 .env

                      # Pull latest image
                      sudo docker pull ${DOCKER_USERNAME}/ytdlp-api:latest

                      # Stop and remove existing container
                      sudo docker stop ytdlp-api 2>/dev/null || true
                      sudo docker rm ytdlp-api 2>/dev/null || true

                      # Run new container
                      # Using host networking or mapping port 80
                      sudo docker run -d \
                        --name ytdlp-api \
                        --restart unless-stopped \
                        -p 80:80 \
                        --env-file .env \
                        -v /opt/ytdlp-api/logs:/app/logs \
                        ${DOCKER_USERNAME}/ytdlp-api:latest

                      # Verify health
                      sleep 10
                      curl -f http://localhost:80/health || exit 1
