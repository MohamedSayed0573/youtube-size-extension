name: Build, Push, and Deploy

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    branches: [main]
    types: 
      - completed
  workflow_dispatch:

jobs:
  build-and-push:
    name: Build & Push to Docker Hub
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./cloud_api
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/ytdlp-api:latest
            ${{ secrets.DOCKER_USERNAME }}/ytdlp-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to AWS EC2
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_IP }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Navigate to app directory
            cd /opt/ytdlp-api
            
            # Create .env file from environment variables
            cat > .env << 'EOF'
            PORT=3000
            NODE_ENV=production
            REQUIRE_AUTH=true
            API_KEY=${{ secrets.API_KEY }}
            ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}
            RATE_LIMIT_WINDOW_MS=60000
            RATE_LIMIT_MAX_REQUESTS=20
            REDIS_ENABLED=${{ secrets.REDIS_ENABLED || 'false' }}
            REDIS_URL=${{ secrets.REDIS_URL }}
            YTDLP_TIMEOUT=25000
            YTDLP_MAX_BUFFER=10485760
            ENABLE_HEALTH_DETAILS=false
            EOF
            
            # Ensure proper permissions
            chmod 600 .env
            
            # Pull latest image
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/ytdlp-api:latest
            
            # Stop and remove existing container
            sudo docker stop ytdlp-api 2>/dev/null || true
            sudo docker rm ytdlp-api 2>/dev/null || true
            
            # Run new container
            sudo docker run -d \
              --name ytdlp-api \
              --restart unless-stopped \
              -p 3000:3000 \
              --env-file .env \
              -v /opt/ytdlp-api/logs:/app/logs \
              ${{ secrets.DOCKER_USERNAME }}/ytdlp-api:latest
            
            # Verify health
            sleep 10
            curl -f http://localhost:3000/health || exit 1
